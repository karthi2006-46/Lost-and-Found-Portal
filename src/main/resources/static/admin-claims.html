<!DOCTYPE html>
<html>
<head>
<title>Admin Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
<div class="container">

<a class="navbar-brand fw-bold">Lost & Found Portal</a>

<div class="ms-auto d-flex align-items-center gap-2">

  <a href="/" class="btn btn-light btn-sm rounded-pill px-3">
    <i class="fa fa-home me-1"></i> Home
  </a>

  <span class="badge bg-light text-dark rounded-pill px-3 py-2">
    <i class="fa fa-user-circle me-1"></i>
    <span id="user"></span>
  </span>

  <button onclick="logout()" class="btn btn-danger btn-sm rounded-pill px-3">
    <i class="fa fa-sign-out-alt me-1"></i> Logout
  </button>

</div>
</div>
</nav>

<div class="container mt-4">
<h4 class="mb-3">Pending Claims</h4>

<table class="table table-bordered table-hover shadow-sm bg-white">
<thead class="table-dark">
<tr>
<th>ID</th>
<th>Item</th>
<th>Claimant</th>
<th>Reason</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</div>

<script>
/* =====================
   ADMIN ACCESS CHECK
   ===================== */
window.onload = () => {
  const token = localStorage.getItem("token");
  const role = localStorage.getItem("role");
  const user = localStorage.getItem("username");

  if (!token || role !== "ADMIN") {
    alert("Access denied. Admin only.");
    window.location = "/login.html";
    return;
  }

  document.getElementById("user").innerText = user;
  load();
};

/* =====================
   LOAD PENDING CLAIMS
   ===================== */
async function load(){
  let res = await fetch("/api/claims/pending", {
    headers:{ "Authorization":"Bearer " + localStorage.getItem("token") }
  });

  if(res.status === 401 || res.status === 403){
    alert("Session expired or unauthorized");
    logout();
    return;
  }

  let data = await res.json();
  let html="";

  if(data.length === 0){
    html = `<tr><td colspan="6" class="text-center text-muted">No pending claims</td></tr>`;
  }

  data.forEach(c=>{
    html += `
    <tr>
      <td>${c.id}</td>

      <td>
        <b>${c.itemPost.title}</b><br>
        <small>${c.itemPost.description ?? ""}</small><br>
        <small>Location: ${c.itemPost.location ?? ""}</small><br>
        <small>Date: ${c.itemPost.dateEvent}</small><br>
        <small><i class="fa fa-phone me-1"></i> ${c.itemPost.mobile}</small>
      </td>

      <td>
        <b>${c.claimant.fullName}</b><br>
        <small>${c.claimant.email}</small>
      </td>

      <td>${c.reason}</td>

      <td>
        <span class="badge bg-warning">${c.status}</span>
      </td>

      <td>
        <button onclick="resolve(${c.id},'APPROVED')" class="btn btn-success btn-sm">Approve</button>
        <button onclick="resolve(${c.id},'REJECTED')" class="btn btn-danger btn-sm">Reject</button>
      </td>
    </tr>`;
  });

  rows.innerHTML = html;
}

/* =====================
   APPROVE / REJECT
   ===================== */
async function resolve(id,status){
  let res = await fetch(`/api/claims/${id}/resolve?status=${status}`,{
    method:"POST",
    headers:{ "Authorization":"Bearer " + localStorage.getItem("token") }
  });

  if(!res.ok){
    alert("Action failed");
    return;
  }

  alert("Claim " + status);
  load();
}

/* =====================
   LOGOUT
   ===================== */
function logout(){
  localStorage.clear();
  window.location = "/login.html";
}
</script>

</body>
</html>
